/*
        License here,
        I dont think too  much about licence
        just feel free to do anything you want... :-)
*/
var App={};App.view={};App.tpl={};App.tpl.Grid=''+'<table class="alpha-grid">'+'<thead class="head" />'+'<tbody class="body" />'+'</table>';App.tpl.PagingToolbar=''+'<table class="ptb-table-bbar">'+'<tr>'+'<td><div id="ptb-first" class="sprite-board-paging sprite-board_paging-first nsb-paging-btn" title="First"></div></td>'+'<td><div id="ptb-prev" class="sprite-board-paging sprite-board_paging-prev nsb-paging-btn" title="Previous"></div></td>'+'<td><div><b>Page  <input id="ptb-current" type="text" class="ptb-current" value="<%= firstPage %>" /> of <span id="ptb-total"><%= lastPage %></span></b></div></td>'+'<td><div id="ptb-next" class="sprite-board-paging sprite-board_paging-next nsb-paging-btn" title="Next"></div></td>'+'<td><div id="ptb-last" class="sprite-board-paging sprite-board_paging-end nsb-paging-btn" title="Last"></div></td>'+'</tr>'+'</table>';App.view.Grid=Backbone.View.extend({tagName:'div',initialize:function(){this.cm=this.options.cm||[];this.sort=this.options.sort||{};this.render();this.renderHeader();},elements:function(){this.els={head:$(this.el).find('.head'),body:$(this.el).find('.body')};},render:function(){this.tpl=_.template(App.tpl.Grid);$(this.el).html(this.tpl());this.elements();return this;},renderHeader:function(){var _this=this;this.els.head.html('');var tr=$('<tr></tr>');_.each(this.cm,function(o){var renderSortable=function(v){var css={textDecoration:'underline',cursor:'pointer',fontWeight:'bold'};var span=$('<span />').css(css).html(v);if(_this.sort[o.id]){var dir=(o.dir==1)?'n':'s';span.append('<span style="float:right;margin-top:6px;" class="ui-icon ui-icon-triangle-1-'+dir+'" />');}
span.on('click',function(){o.dir=(o.dir==1)?-1:1;sort={};sort[o.id]=o.dir;_this.sort=sort;_this.trigger('sort',sort);});return span;}
var html=o.sortable?renderSortable(o.name):o.name;var th=$('<th></th>').html(html);if(o.width)th.width(o.width);if(o.hcls)th.addClass(o.hcls);if(o.hcss)th.css(o.hcss);tr.append(th);this.els.head.append(tr);},this);},setValues:function(data){this.renderHeader();this.els.body.html('');var _this=this;_.each(data,function(o){var tr=$('<tr></tr>');_.each(this.cm,function(c){var v=o[c.id];var val=c.render?c.render(v,o):v;var td=$('<td></td>').html(val);if(c.cls)td.addClass(c.cls);if(c.css)td.css(c.css);tr.append(td);},this);tr.on('click',function(){_this.trigger('rowclick',o);});this.els.body.append(tr);},this);},getSort:function(){return this.sort;},setSort:function(sort){this.sort=sort;}});App.view.PagingToolbar=Backbone.View.extend({firstPage:1,lastPage:1,currentPage:1,tagName:'div',notLimit:99999,events:{'click  #ptb-first':'setFirstPage','click  #ptb-prev':'prevPage','click  #ptb-next':'nextPage','click  #ptb-last':'setLastPage','keypress #ptb-current':'keypress','change #ptb-current':'change'},initialize:function(){this.lastPage=this.options.lastPage||this.lastPage;if(this.lastPage=='?')this.lastPage=this.notLimit;this.render();$('.sprite-board-paging').tipsy({gravity:'s',fade:true});},elements:function(){this.els={currentPage:$(this.el).find('#ptb-current')};},render:function(){var s={firstPage:this.firstPage,lastPage:(this.lastPage==this.notLimit)?'?':this.lastPage};this.tpl=_.template(App.tpl.PagingToolbar,s);$(this.el).html(this.tpl);this.elements();return this;},nextPage:function(){var p=this.getPage();if(p<this.lastPage)
this.setPage(++p);},prevPage:function(){var p=this.getPage();if(p>this.firstPage)
this.setPage(--p);},change:function(e){var p=this.getPage();if(p>this.lastPage){this.setPage(this.currentPage);return false;}
if(p<this.firstPage||_.isNaN(p)){this.setPage(this.firstPage);return false;}
this.setPage(p);},keypress:function(e){return/\d/.test(String.fromCharCode(e.keyCode));},getPage:function(){return parseInt(this.els.currentPage.val());},setPage:function(p,preventEvent){this.curentPage=p;this.els.currentPage.val(p);if(!preventEvent)this.trigger('pageChange',p);},setLastPage:function(){this.setPage(this.lastPage);},setFirstPage:function(){this.setPage(this.firstPage);}});